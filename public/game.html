<!DOCTYPE html>
<html>
    <head>
        <script src="p5.min.js"></script>
        <script>
            var halfWidth = 256;
            class Cell
            {
                constructor(x,y,id,vx,vy)
                {
                    this.x = x;
                    this.y = y;
                    this.id = id;
                    this.vx = vx;
                    this.vy = vy;
                }
                move()
                {
                    var angle = Math.atan2(mouseY-halfWidth,mouseX-halfWidth);
                    this.vx = Math.cos(angle)*Math.min(1,(Math.abs(mouseX-halfWidth)/20));
                    this.vy = Math.sin(angle)*Math.min(1,(Math.abs(mouseY-halfWidth)/20));
                    this.x += this.vx;
                    this.y += this.vy;
                }
                split()
                {
                    let splitCells = [this];
                    return splitCells; //temporary, could return an array with multiple cells if a split occured
                }
                draw()
                {
                    ellipse(this.x, this.y, 32, 32);
                }
            }
            class Camera
            {
                constructor()
                {
                    this.camX = 0;
                    this.camY = 0;
                }
                track(cells)
                {
                    this.camX = 0;
                    this.camY = 0;
                    for(let i = 0; i < cells.length; i++)
                    {
                        this.camX += cells[i].x;
                        this.camY += cells[i].y;
                    }
                    this.camX = -this.camX/cells.length + halfWidth;
                    this.camY = -this.camY/cells.length + halfWidth;
                    translate(this.camX,this.camY);
                }
            }
            class Client
            {
                constructor()
                {
                    this.localIds = [];
                    this.cellList = [];
                    this.webSock = null;
                }
                setSocket(webSock)
                {
                    this.webSock = webSock;
                }
                findCellFromId(id)
                {
                    for(let i = 0; i < this.cellList.length; i++)
                    {
                        let cell = this.cellList[i];
                        if(cell.id == id)
                        {
                            return cell;
                        }
                    }
                    return null;
                }
                updateCells()
                {
                    for(let i = 0; i < this.localIds.length; i++) //local cell movement and splitting
                    {
                        let c = findCellFromId(localIds[i]);
                        if(c != null)
                        {
                            c.move();
                            //something something about splitting here maybe
                        }
                    }

                    this.sendCells();
                    
                    for(let i = 0; i < this.cellList.length; i++)
                    {
                        this.cellList[i].draw();
                    }
                }
                sendCells()
                {
                    let cellDataList = [];
                    for(let i = 0; i < this.localIds.length; i++)
                    {
                        let c = findCellFromId(localIds[i]);
                        cellDataList.push({
                            x: c.x,
                            y: c.y,
                            id: c.id,
                            vx: c.vx,
                            vy: c.vy
                        });
                    }
                    this.webSock.send(JSON.stringify({
                        type: "allCellUpdate",
                        cellList: cellDataList
                    }));
                    
                }
                receiveMyCells(ids)
                {
                    this.clientCellIds = ids;
                }
                //here we have to process the list of json objects and turn them into an actual cell list
                //is this the best way to do this, or should we update the cells in the current list instead of essentially overwriting every time?
                receiveCells(cells) 
                {
                    this.cellList = [];
                    for(let i = 0; i < cells.length; i++)
                    {
                        c = cells[i];
                        this.cellList.push(new Cell(c.x,c.y,c.id,c.vx,c.vy));
                    }
                }
            }
            var client = new Client();
            var cam = new Camera();
            var connected = false;
            var ws = new WebSocket("ws://127.0.0.1:5524");
            ws.onopen = function() {
                console.log("connected");
                ws.send(JSON.stringify({
                    type: "register"
                }));
                connected = true;
                gw.setSocket(ws);
            };
            ws.onmessage = function(ev) {
                let data = JSON.parse(ev.data);
                if (data.type == "youare")
                {
                    pd.receiveMyCells(data.cellIds);
                }
                else if(data.type == "allCellUpdate")
                {
                    pd.receiveCells(data.cellDataList);
                }
            };
            function setup()
            {
                createCanvas(512, 512);
            }
            function draw()
            {
                background(0);
                
                if(connected)
                {
                    cam.track(pd.clientCells);
                    pd.updateCells(ws);
                }
                rect(64,64,64,64);
            }
        </script>
    </head>
    <body>

    </body>
</html>
<!DOCTYPE html>
<html>
    <head>
        <script src="p5.min.js"></script>
        <script>
            var halfWidth = 256;
            class Cell
            {
                constructor()
                {
                    this.x = 0;
                    this.y = 0;
                    this.xVel = 0;
                    this.yVel = 0;
                }
                move()
                {
                    var angle = Math.atan2(mouseY-halfWidth,mouseX-halfWidth);
                    this.xVel = Math.cos(angle)*Math.min(1,(Math.abs(mouseX-halfWidth)/20));
                    this.yVel = Math.sin(angle)*Math.min(1,(Math.abs(mouseY-halfWidth)/20));
                    this.x += this.xVel;
                    this.y += this.yVel;
                }
                split()
                {
                    let splitCells = [this];
                    return splitCells; //temporary, could return an array with multiple cells if a split occured
                }
                draw()
                {
                    ellipse(this.x, this.y, 32, 32);
                }
            }
            class Camera
            {
                constructor()
                {
                    this.camX = 0;
                    this.camY = 0;
                }
                track(cells)
                {
                    this.camX = 0;
                    this.camY = 0;
                    for(let i = 0; i < cells.length; i++)
                    {
                        this.camX += cells[i].x;
                        this.camY += cells[i].y;
                    }
                    this.camX = -this.camX/cells.length + halfWidth;
                    this.camY = -this.camY/cells.length + halfWidth;
                    translate(this.camX,this.camY);
                }
            }
            class PetriDish //haha petri dishes hold cells
            {
                constructor()
                {
                    this.clientCells = [new Cell()]; //start out with one local cell
                    this.serverCells = [];
                }
                updateCells(webSock)
                {
                    for(let i = 0; i < this.clientCells.length; i++) //local cell movement and splitting
                    {
                        this.clientCells[i].move();
                        let splitCells = this.clientCells[i].split();
                        this.clientCells.splice(i,1);
                        this.clientCells.push(...splitCells);
                    }
                    this.sendCells(webSock);
                    
                    //if any client sided cells do not appear in the list that we get back from the server, those cells have died
                    let allCells = [];
                    allCells.push(...serverCells);
                    for(let i = 0; i < allCells.length; i++)
                    {
                        allCells[i].draw();
                    }
                }
                sendCells(webSock)
                {
                    webSock.send(this.clientCells);
                }
                recieveCells(cells)
                {
                    this.serverCells = cells;
                }
            }
            var c = new Cell();
            var pd = new PetriDish();
            var cam = new Camera();
            var ws = new WebSocket("ws://127.0.0.1:5524");
            ws.onopen = function() {
                console.log("connected");
            };
            ws.onmessage = function(ev) {
                console.log(JSON.parse(ev.data));
                pd.recieveCells(JSON.parse(ev.data));
            };
            function setup()
            {
                createCanvas(512, 512);
            }
            function draw()
            {
                background(0);
                cam.track(pd.clientCells);
                pd.updateCells(ws);
                
                rect(64,64,64,64);
            }
        </script>
    </head>
    <body>

    </body>
</html>